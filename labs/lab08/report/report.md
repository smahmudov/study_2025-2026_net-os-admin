---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Суннатилло Махмудов"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTPсервера.

# Теоретические сведения по работе

Почтовый сервер **Postfix** — это агент пересылки почты (Mail Transfer Agent, MTA), обеспечивающий приём, обработку и доставку электронных сообщений как внутри системы, так и между различными хостами и доменами.  
Он служит связующим звеном между почтовыми клиентами (MUA) и другими серверами в сети, реализуя поддержку протоколов **SMTP (Simple Mail Transfer Protocol)**, **ESMTP** и **LMTP**.

## Основные компоненты Postfix

1. **master** — основной управляющий процесс, который запускает остальные службы Postfix и следит за их состоянием.  
2. **smtpd** — серверный демон, принимающий входящие SMTP-соединения и обрабатывающий почту, поступающую на сервер.  
3. **pickup** — процесс, отвечающий за приём локально отправляемых писем из каталога **/var/spool/postfix/maildrop**.  
4. **qmgr** — диспетчер очередей, который управляет обработкой сообщений, находящихся в очереди на доставку.  
5. **local** — агент, осуществляющий доставку почты локальным пользователям (в каталоги **/var/spool/mail/**).  
6. **cleanup** — фильтрует и подготавливает сообщения перед добавлением их в очередь.  
7. **trivial-rewrite** — отвечает за анализ и преобразование адресов в процессе маршрутизации сообщений.

## Основные файлы конфигурации

- **/etc/postfix/main.cf** — основной конфигурационный файл Postfix, где задаются параметры работы сервера (домен, интерфейсы, сети, параметры безопасности и маршрутизации).  
- **/etc/postfix/master.cf** — файл, описывающий запуск и параметры служб Postfix (демонов и процессов).  
- **/var/log/maillog** — журнал, в котором фиксируются все события, связанные с приёмом, отправкой и ошибками доставки сообщений.  
- **/var/spool/postfix/** — каталог, содержащий очередь писем (ожидающих отправки, в процессе доставки и завершённых сообщений).

## Основные параметры конфигурации Postfix

- **myhostname** — полное имя хоста сервера;  
- **mydomain** — доменное имя, с которым работает сервер;  
- **myorigin** — домен, из которого исходят письма по умолчанию;  
- **mydestination** — домены, для которых данный сервер является конечным получателем почты;  
- **relayhost** — промежуточный почтовый сервер, через который могут пересылаться сообщения;  
- **inet_interfaces** — сетевые интерфейсы, на которых Postfix принимает входящие соединения;  
- **mynetworks** — список доверенных сетей, которым разрешено отправлять почту через сервер;  
- **inet_protocols** — набор поддерживаемых сетевых протоколов (обычно `ipv4` или `all`).

# Выполнение лабораторной работы

## Установка и запуск почтового сервера Postfix

1. На виртуальной машине **server** выполнен вход под пользователем и произведён переход в режим суперпользователя:  
   sudo -i

2. Были установлены необходимые пакеты для работы почтового сервера **Postfix** и утилиты **s-nail**:  
   dnf -y install postfix  
   dnf -y install s-nail  

   ![Установка пакета s-nail и зависимостей](01.png){ #fig:001 width=80% }

3. Для обеспечения работы службы SMTP в межсетевом экране были добавлены соответствующие разрешения:  
   firewall-cmd --add-service=smtp  
   firewall-cmd --add-service=smtp --permanent  
   firewall-cmd --list-services  

4. Выполнено восстановление контекста безопасности SELinux для корректной работы служб:  
   restorecon -vR /etc

5. Почтовый сервер **Postfix** был включён в автозагрузку и запущен:  
   systemctl enable postfix  
   systemctl start postfix  

## Изменение параметров Postfix с помощью postconf

1. Для просмотра списка текущих настроек почтового сервера **Postfix** была выполнена команда:  
   postconf  

   ![Просмотр всех параметров конфигурации Postfix](02.png){ #fig:002 width=80% }

2. Проверено текущее значение параметра **myorigin**:  
   postconf myorigin  

   Результат показал:  
   myorigin = $myhostname  

3. Аналогично просмотрено значение параметра **mydomain**:  
   postconf mydomain  

   Получено значение:  
   mydomain = smahmudov.net  

   ![Проверка параметров myorigin и mydomain](03.png){ #fig:003 width=80% }

4. Значение параметра **myorigin** было изменено на **$mydomain**:  
   postconf -e 'myorigin = $mydomain'  

   После проверки параметра командой  
   postconf myorigin  
   установлено, что теперь он имеет значение **$mydomain**.  

5. Проверена корректность конфигурации:  
   postfix check  

6. Для применения изменений выполнена перезагрузка службы Postfix:  
   systemctl reload postfix  

   ![Перезагрузка конфигурации Postfix](04.png){ #fig:004 width=80% }

7. Для отображения всех параметров, отличающихся от значений по умолчанию, использована команда:  
   postconf -n  

   ![Вывод параметров, отличающихся от стандартных](05.png){ #fig:005 width=80% }

8. Далее выполнено жёсткое задание доменного имени:  
   postconf -e 'mydomain = smahmudov.net'  

9. Проверено значение параметра **inet_protocols**, после чего IPv6 был отключён, оставлен только IPv4:  
   postconf inet_protocols  
   postconf -e 'inet_protocols = ipv4'  

10. Повторно выполнена проверка конфигурации и перечитывание параметров службы:  
    postfix check  
    systemctl reload postfix.service  

## Проверка работы почтового сервера Postfix

1. На сервере под учётной записью пользователя **smahmudov** было отправлено тестовое письмо самому себе с использованием утилиты **mail**:  
   echo . | mail -s test1 smahmudov@server.smahmudov.net  

2. Для наблюдения за процессом доставки сообщения был запущен мониторинг журнала почтовой службы:  
   tail -f /var/log/maillog  

   В логе видно, что сообщение было успешно доставлено локально:  `status=sent (delivered to mailbox)`
   
Это подтверждает корректную работу локальной доставки почты.  

![Мониторинг журнала доставки почты](06.png){ #fig:006 width=80% }

3. Проверено наличие письма в каталоге пользователя:  
/var/spool/mail/smahmudov  

Просмотр содержимого файла подтвердил получение письма с темой **test1**.  
Письмо пришло от **smahmudov@smahmudov.net** и было принято сервером **Postfix**.  

![Проверка полученного письма на сервере](07.png){ #fig:007 width=80% }

4. На виртуальной машине **client** был выполнен вход в систему под пользователем и произведён переход в режим суперпользователя:  
sudo -i  

5. На клиенте установлены необходимые пакеты **postfix** и **s-nail**:  
dnf -y install postfix  
dnf -y install s-nail  

После установки отключён IPv6 и оставлен только IPv4:  
postconf inet_protocols  
postconf -e 'inet_protocols = ipv4'  

Затем служба Postfix была включена и запущена:  
systemctl enable postfix  
systemctl start postfix  

![Настройка и запуск Postfix на клиенте](08.png){ #fig:008 width=80% }

6. На клиенте под учётной записью пользователя отправлено письмо на сервер:  
echo . | mail -s test2 smahmudov@server.smahmudov.net  

В журнале сервера видно, что соединение установлено с клиента **client.smahmudov.net**, сообщение получено и успешно доставлено в почтовый ящик:  `status=sent (delivered to mailbox)`


![Лог доставки письма с клиента на сервер](09.png){ #fig:009 width=80% }

7. Для корректного взаимодействия между узлами сети были проверены и изменены сетевые параметры Postfix:  
postconf inet_interfaces  
postconf mynetworks  

Далее серверу разрешено прослушивание всех интерфейсов:  
postconf -e 'inet_interfaces = all'  

И добавлены адреса доверенных сетей:  
postconf -e 'mynetworks = 127.0.0.0/8, 192.168.0.0/16'  

После внесения изменений служба Postfix была перезапущена:  
postfix check  
systemctl reload postfix  
systemctl stop postfix  
systemctl start postfix  

![Настройка параметров inet_interfaces и mynetworks](10.png){ #fig:010 width=80% }

8. Повторная отправка письма с клиента показала успешную доставку сообщения на сервер, что подтверждает корректную настройку взаимодействия почтовых узлов в локальной сети.

## Конфигурация Postfix для домена

1. С клиента было отправлено письмо на доменный адрес пользователя:  
   echo . | mail -s test2 smahmudov@smahmudov.net  

2. При первичной отправке сообщение не было доставлено, так как сервер не принимал соединения по порту **25/tcp**.  
   Проверка очереди сообщений командой  
   postqueue -p  
   показала, что письма остаются в очереди с ошибкой **Connection refused**.  

   ![Очередь сообщений с ошибкой соединения](12.png){ #fig:012 width=80% }

3. Для обеспечения доставки писем на уровне домена была выполнена настройка прямой DNS-зоны **smahmudov.net**, где добавлена MX-запись, указывающая на почтовый сервер **mail.smahmudov.net**:  


Также были добавлены записи A для основных сервисов, включая **mail**, **www**, **dhcp** и **ns**.  

![Файл прямой DNS-зоны smahmudov.net](13.png){ #fig:013 width=80% }

4. В файле обратной зоны **1.168.192.in-addr.arpa** добавлены записи PTR, соответствующие именам узлов, включая **mail.smahmudov.net**.  

![Файл обратной DNS-зоны 1.168.192.in-addr.arpa](14.png){ #fig:014 width=80% }

5. В конфигурации **Postfix** на сервере было расширено значение параметра **mydestination**, чтобы сервер принимал почту для домена **smahmudov.net**:  
postconf -e 'mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain'  

После проверки и применения конфигурации:  
postfix check  
systemctl reload postfix.service  

Также были восстановлены контексты безопасности SELinux и перезапущен DNS-сервер:  
restorecon -vR /etc  
restorecon -vR /var/named  
systemctl restart named  

![Перенастройка Postfix и восстановление контекстов SELinux](15.png){ #fig:015 width=80% }

6. После внесения изменений и обновления конфигурации Postfix письмо из очереди было успешно отправлено.  
Повторный мониторинг логов показал успешное установление соединения между клиентом и сервером и доставку письма

![Успешная доставка письма на доменный адрес](16.png){ #fig:016 width=80% }

7. Просмотр содержимого почтового ящика подтвердил получение письма **test2** от клиента **client.smahmudov.net**.  
Сообщение было корректно обработано сервером **Postfix** и помещено в локальный почтовый ящик пользователя.  

![Полученное письмо с клиента на сервер](17.png){ #fig:017 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На виртуальной машине **server** выполнен переход в каталог для изменения настроек внутреннего окружения:  
   cd /vagrant/provision/server/

2. Для сохранения актуальных настроек DNS-сервера были скопированы конфигурационные файлы из системного каталога:  
   cd /vagrant/provision/server/dns/var/named  
   cp -R /var/named/* /vagrant/provision/server/dns/var/named  

3. В каталоге **/vagrant/provision/server/** был создан исполняемый файл **mail.sh**:  

4. В файл **mail.sh** был добавлен сценарий автоматического развертывания и настройки почтового сервера **Postfix**.  
Скрипт выполняет установку необходимых пакетов, настройку межсетевого экрана, конфигурацию Postfix и запуск службы.  

![Сценарий mail.sh для сервера Postfix](18.png){ #fig:018 width=80% }

5. Для клиента также создан упрощённый вариант скрипта **mail.sh**, предназначенный для базовой установки и запуска Postfix с использованием IPv4-протокола.  

![Сценарий mail.sh для клиента](19.png){ #fig:019 width=80% }

# Вывод

В ходе лабораторной работы был установлен и настроен почтовый сервер **Postfix**.  
Произведена настройка локальной и доменной доставки сообщений, добавлены необходимые DNS-записи (A, PTR, MX) для корректной маршрутизации почты.  
Проверка с помощью утилит **mail** и **postqueue** подтвердила успешную доставку писем как внутри сервера, так и между клиентом и сервером.  
Также реализована автоматизация настройки почтового окружения с помощью сценариев **mail.sh**.

# Контрольные вопросы

1. **В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?**  
   Основной конфигурационный файл Postfix находится в каталоге **/etc/postfix/** и называется **main.cf**.  
   Дополнительные параметры и таблицы описаны в файлах **master.cf**, **aliases**, **virtual** и других вспомогательных файлах той же директории.

2. **Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?**  
   Для проверки синтаксиса и правильности конфигурации используется команда:  postfix check
   Она анализирует файлы конфигурации и выводит сообщения об ошибках или неверных параметрах, если таковые имеются.

3. **В каких параметрах конфигурации Postfix требуется внести изменения в значениях для настройки возможности отправки писем не на локальный хост, а на доменные адреса?**  
Для организации отправки почты на доменные адреса изменяются следующие параметры:  
- **mydomain** — задаёт доменное имя, например *smahmudov.net*;  
- **myorigin** — определяет домен, из которого исходят письма (обычно совпадает с *$mydomain*);  
- **mydestination** — список доменов, для которых сервер принимает почту;  
- **relayhost** — (при необходимости) указывает промежуточный сервер для пересылки писем;  
- **inet_interfaces** и **mynetworks** — задают интерфейсы и сети, с которых разрешена отправка писем.

4. **Приведите примеры работы с утилитой mail по отправке письма, просмотру имеющихся писем, удалению письма.**  
- Отправка письма:  
  ```
  echo "Текст письма" | mail -s "Тема" user@domain.net
  ```  
- Просмотр всех писем:  
  ```
  mail
  ```  
  После входа в интерактивный режим можно:
  - Просмотреть письмо — ввести его номер;
  - Удалить письмо — ввести `d <номер>`;
  - Выйти с сохранением изменений — `q`.

5. **Приведите примеры работы с утилитой postqueue. Как посмотреть очередь сообщений? Как определить число сообщений в очереди? Как отправить все сообщения, находящиеся в очереди? Как удалить письмо из очереди?**  
- Просмотр очереди сообщений:  
  ```
  postqueue -p
  ```  
- Определение числа сообщений в очереди:  
  ```
  mailq | grep -c '^[A-F0-9]'
  ```  
- Повторная отправка всех сообщений из очереди:  
  ```
  postqueue -f
  ```  
- Удаление конкретного письма из очереди:  
  ```
  postsuper -d <ID_сообщения>
  ```  
- Очистка всей очереди сообщений:  
  ```
  postsuper -d ALL
  ```

# Список литературы

1. Postfix Documentation. — URL: http://www.postfix.org/documentation.html (visited on 09/13/2021).