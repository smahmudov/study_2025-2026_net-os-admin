---
## Front matter
title: "Отчёт по лабораторной работе 13"
subtitle: "Настройка NFS"
author: "Суннатилло Махмудов"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Теоретические сведения

**Network File System (NFS)** — это сетевая файловая система, разработанная компанией **Sun Microsystems**, которая позволяет различным узлам в сети обмениваться файлами и каталогами так, как если бы они находились в локальной файловой системе.  
Основное назначение NFS — организация централизованного хранения данных с возможностью их совместного использования.

## Принцип работы NFS

Работа NFS основана на архитектуре **клиент–сервер**.  
Сервер экспортирует (предоставляет общий доступ) к определённым каталогам, а клиенты монтируют эти каталоги в свою локальную файловую систему. Таким образом, пользователь может работать с удалёнными файлами как с локальными.

Для взаимодействия NFS использует набор RPC-служб (Remote Procedure Call).  
Основные компоненты:
- **rpcbind** — служба, регистрирующая RPC-процессы и сопоставляющая их номера портов;  
- **nfsd** — демон, обеспечивающий обработку запросов от клиентов;  
- **mountd** — служба, отвечающая за экспорт и монтирование каталогов;  
- **statd** и **lockd** — обеспечивают блокировку и согласованность доступа к файлам.

## Версии протокола NFS

Наиболее распространённые версии — **NFSv3** и **NFSv4**:  
- **NFSv3** — использует UDP/TCP и не требует авторизации, проста в настройке, но менее безопасна;  
- **NFSv4** — поддерживает работу через один порт (2049), интегрирована с механизмами **Kerberos**, поддерживает ACL и улучшенную производительность.

# Выполнение лабораторной работы

## Настройка сервера NFSv4

1. На виртуальной машине **server** был установлен необходимый пакет nfs-utils и его зависимости. После завершения установки выполнен перезапуск системных демонов для применения новых конфигураций.

   ![Установка и перезапуск демонов systemd](01.png){ #fig:001 width=80% }

2. Был создан каталог, предназначенный для экспорта через NFS, и отредактирован файл **/etc/exports**, где задан общий ресурс с доступом только на чтение:

   /srv/nfs *(ro)

   ![Создание каталога и редактирование файла /etc/exports](02.png){ #fig:002 width=80% }

3. Для каталога `/srv/nfs` был установлен контекст безопасности **nfs_t**, после чего были применены изменения SELinux.

   ![Настройка контекста безопасности SELinux для каталога /srv/nfs](03.png){ #fig:003 width=80% }

4. Был запущен и добавлен в автозагрузку сервис NFS. Для корректной работы сервера также были добавлены необходимые службы в брандмауэр и произведена перезагрузка его конфигурации.

   ![Запуск сервиса NFS и настройка правил межсетевого экрана](04.png){ #fig:004 width=80% }

5. На виртуальной машине **client** был установлен пакет **nfs-utils** и выполнена проверка доступных экспортируемых каталогов на сервере. Команда вывела список экспортируемых директорий, доступных клиентам сети.

   ![Проверка доступных экспортов на клиенте](05.png){ #fig:005 width=80% }

6. После добавления дополнительных служб **rpc-bind** и **mountd** в настройки брандмауэра на сервере была выполнена повторная проверка, показавшая корректный список экспортов.

   ![Добавление служб mountd и rpc-bind и повторная проверка доступности экспорта](06.png){ #fig:006 width=80% }

## Монтирование NFS на клиенте

1. На клиентской машине был создан каталог **/mnt/nfs**, после чего удалённый ресурс был смонтирован в него. Проверка подключённых файловых систем показала, что NFS-ресурс успешно смонтирован.

   ![Монтирование и проверка NFS-ресурса на клиенте](07.png){ #fig:007 width=80% }

2. Для обеспечения автоматического монтирования при загрузке системы в конец файла **/etc/fstab** была добавлена строка:

   server.smahmudov.net:/srv/nfs /mnt/nfs nfs _netdev 0 0

   Здесь параметр **_netdev** указывает, что устройство зависит от сети, и его монтирование должно выполняться после активации сетевых служб.

   ![Добавление записи для автоматического монтирования в /etc/fstab](08.png){ #fig:008 width=80% }

3. Проверка статуса цели **remote-fs.target**, отвечающей за автоматическое подключение удалённых файловых систем, показала активное состояние сервиса.

   ![Проверка состояния remote-fs.target](09.png){ #fig:009 width=80% }

4. После перезапуска клиента было подтверждено, что каталог NFS автоматически подключается при старте системы.

## Подключение каталогов к дереву NFS

1. На сервере был создан каталог **/srv/nfs/www**, предназначенный для размещения контента веб-сервера, экспортируемого через NFS.

2. Каталог **/var/www** был подмонтирован в созданный каталог **/srv/nfs/www** с использованием опции **bind**, что позволило отразить содержимое веб-каталога в дереве NFS.

   ![Редактирование файла /etc/fstab для монтирования каталога веб-сервера](10.png){ #fig:010 width=80% }

3. Проверка содержимого каталога **/srv/nfs** показала наличие подкаталога **www**, что подтверждает успешное монтирование каталога веб-сервера.

4. На клиентской машине в каталоге **/mnt/nfs** также был отображён подкаталог **www**, что свидетельствует о корректной работе экспортируемого ресурса.

   ![Проверка доступности каталога www на клиенте](11.png){ #fig:011 width=80% }

5. В файл **/etc/exports** на сервере была добавлена строка, разрешающая запись в каталог **/srv/nfs/www** для узлов из подсети **192.168.0.0/16**:

   /srv/nfs/www 192.168.0.0/16(rw)

   ![Добавление записи экспорта каталога веб-сервера в /etc/exports](12.png){ #fig:012 width=80% }

6. После обновления конфигурации экспортов команда `exportfs -r` применила изменения, и каталог **/srv/nfs/www** стал доступен клиентам сети с правами записи.

7. На клиенте была повторно проведена проверка содержимого каталога **/mnt/nfs**, подтвердившая успешный экспорт и доступность каталога веб-сервера.

## Подключение каталогов для работы пользователей

1. На сервере под пользователем **smahmudov** был создан каталог `common` с правами доступа только для владельца. Внутри каталога был создан файл `smahmudov@server.txt`. Каталог защищён правами **700**, что обеспечивает доступ лишь владельцу.

   ![Создание каталога common и файла на сервере](13.png){ #fig:013 width=80% }

2. В директории NFS на сервере был подготовлен каталог `/srv/nfs/home/smahmudov` для сетевого доступа пользователя.

3. Локальный каталог пользователя был подмонтирован в структуру NFS. В результате каталог `/srv/nfs/home/smahmudov` стал отражать содержимое `~/common`. Права доступа на каталог сохранились — доступ разрешён только владельцу.

   ![Добавление записи в /etc/exports для домашнего каталога пользователя](14.png){ #fig:014 width=80% }

4. В файл **/etc/exports** была добавлена строка, разрешающая rw-доступ клиентам в сети

После этого конфигурация экспортов была обновлена.

5. Для постоянного монтирования в **/etc/fstab** была внесена запись, обеспечивающая привязку локального каталога пользователя к каталогу экспортируемому через NFS:

![Настройка постоянного bind-монтирования в /etc/fstab](15.png){ #fig:015 width=80% }

6. После повторного экспорта каталогов на клиенте в структуре `/mnt/nfs` появился каталог домашнего пространства пользователя.

7. На клиенте пользователь перешёл в каталог `/mnt/nfs/home/smahmudov` и создал файл `smahmudov@client.txt`. Файл успешно появился, что подтверждает корректность записи и синхронизации.

![Создание файла на клиенте в NFS-каталоге](16.png){ #fig:016 width=80% }

8. При попытке выполнить те же действия от имени root на клиенте доступ был запрещён, что подтверждает корректное разграничение прав доступа.

![Попытка доступа root к каталогу пользователя](17.png){ #fig:017 width=80% }

9. На сервере в каталоге `~/common` были видны оба файла — созданный на сервере и созданный на клиенте, что подтверждает корректность двусторонней синхронизации через NFS.

![Проверка файлов на сервере](18.png){ #fig:018 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине **server** был выполнен переход в каталог **/vagrant/provision/server/**, где создана структура каталогов для хранения конфигурационных файлов NFS:

   /vagrant/provision/server/nfs/etc

   В созданный каталог были скопированы файлы конфигурации сервера NFS, включая **/etc/exports**.

2. В каталоге **/vagrant/provision/server/** был создан исполняемый скрипт **nfs.sh**, содержащий команды для автоматической настройки и запуска NFS-сервера. Скрипт выполняет установку пакетов, настройку SELinux, конфигурацию межсетевого экрана, монтирование каталогов и добавление записей в **/etc/fstab**.

   ![Содержимое скрипта nfs.sh на сервере](19.png){ #fig:019 width=80% }

3. Аналогичный скрипт был создан на виртуальной машине **client**, обеспечивающий автоматическое подключение удалённого NFS-ресурса при инициализации системы. В нём реализованы установка клиента NFS, создание точки монтирования и добавление соответствующей записи в файл **/etc/fstab**.

   ![Содержимое скрипта nfs.sh на клиенте](20.png){ #fig:020 width=80% }

4. После запуска скриптов сервер и клиент корректно настроили взаимодействие по протоколу NFS, обеспечив автоматическое монтирование каталогов и доступность экспортируемых ресурсов.

# Вывод

В ходе лабораторной работы был развернут и настроен сервер **NFSv4**, обеспечивающий совместный доступ к каталогам между сервером и клиентом.  
На стороне сервера выполнена настройка экспорта директорий, конфигурация SELinux и правил брандмауэра, а также организация автоматического монтирования через **/etc/fstab**.  
На клиентской машине реализовано подключение удалённых ресурсов с автоматической инициализацией при запуске системы.  
Проверка показала корректную синхронизацию данных и разграничение прав доступа пользователей.

# Контрольные вопросы

1. **Как называется файл конфигурации, содержащий общие ресурсы NFS?**  
   Конфигурация экспортируемых ресурсов NFS хранится в файле **/etc/exports**, где указываются пути к каталогам, параметры доступа и список сетей или хостов, которым разрешено подключение.  

2. **Какие порты должны быть открыты в брандмауэре, чтобы обеспечить полный доступ к серверу NFS?**  
   Для корректной работы NFS необходимо открыть следующие порты:  
   – **2049/tcp и 2049/udp** — основной порт сервиса NFS;  
   – **111/tcp и 111/udp** — служба **rpcbind**;  
   – порты, используемые сервисами **mountd**, **nlockmgr** и **statd** (динамические, задаются в конфигурации при необходимости).  

3. **Какую опцию следует использовать в /etc/fstab, чтобы убедиться, что общие ресурсы NFS могут быть установлены автоматически при перезагрузке?**  
   Для автоматического монтирования сетевых ресурсов при запуске системы используется опция **_netdev**, указывающая, что устройство зависит от сети и должно подключаться только после инициализации сетевых служб.

# Список литературы

1. **Red Hat Documentation — Network File System (NFS)**  
   https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/managing_file_systems/using-nfs-to-share-directories_managing-file-systems  

2. **The Linux NFS HOWTO**  
   https://tldp.org/HOWTO/NFS-HOWTO/index.html  