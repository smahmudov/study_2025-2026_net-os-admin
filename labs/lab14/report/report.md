---
## Front matter
title: "Отчёт по лабораторной работе 14"
subtitle: "Настройка файловых служб Samba"
author: "Суннатилло Махмудов"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки доступа групп пользователей к общим ресурсам по протоколу SMB.

# Теоретические сведения

**Samba** — это программный комплекс, реализующий протокол SMB/CIFS и обеспечивающий взаимодействие между системами Linux и Windows в локальных сетях. Samba позволяет предоставлять сетевые каталоги, принтеры, а также реализовывать доменные службы и аутентификацию.

Основой работы Samba является протокол **SMB (Server Message Block)**, который отвечает за обмен файлами, доступ к каталогам, сетевым принтерам и другим ресурсам. В современных системах используется версия протокола **CIFS (Common Internet File System)** и его более новые модификации — SMB2 и SMB3.

Samba состоит из нескольких ключевых компонентов:  
- служба **smbd**, обеспечивающая доступ к файлам и принтерам;  
- служба **nmbd**, отвечающая за NetBIOS-имя хоста и работу браузера сети (в новых системах может быть отключена);  
- служба **winbindd**, позволяющая интегрировать сервер Linux в домены Windows для аутентификации пользователей.

Конфигурация Samba хранится в файле **/etc/samba/smb.conf**, где определяются параметры сервера и описание доступных ресурсов. Каждый общий ресурс описывается отдельным разделом, содержащим путь, права доступа, а также дополнительные параметры безопасности.

Управление доступом к ресурсам осуществляется в несколько уровней. Базовые права задаются файловой системой Linux, более детальная настройка производится средствами Samba через такие параметры, как списки пользователей, группы, разрешения на чтение и запись. Для защиты сетевых подключений используется межсетевой экран и контекст безопасности SELinux, который должен соответствовать правилам доступа Samba к каталогам.

Монтирование ресурсов Samba на клиентах выполняется с использованием подсистемы CIFS. Подключение может выполняться как вручную, так и автоматически — через файл /etc/fstab с указанием реквизитов доступа или внешнего файла с учётными данными.

# Выполнение лабораторной работы

## Настройка сервера Samba

1. На сервер были установлены необходимые пакеты.

2. Создана группа sambagroup с GID 1010.

3. Пользователь был добавлен в группу sambagroup.

4. Создан каталог /srv/sambashare для общего ресурса.

![Создание каталога /srv/sambashare](01.png){ #fig:001 width=80% }

5. В файле /etc/samba/smb.conf был изменён параметр рабочей группы, а также добавлена секция sambashare с описанием общего ресурса.

![Настройка smb.conf](02.png){ #fig:002 width=80% }

6. Конфигурация Samba была проверена на наличие ошибок с помощью testparm.

7. Служба smb была запущена, добавлена в автозагрузку и её статус был проверен.

![Статус службы smb](03.png){ #fig:003 width=80% }

8. Проверена доступность общего ресурса с использованием smbclient.

![Проверка через smbclient](04.png){ #fig:004 width=80% }

9. Был изучен файл конфигурации межсетевого экрана /usr/lib/firewalld/services/samba.xml.

![Просмотр файла samba.xml](05.png){ #fig:005 width=80% }

10. Межсетевой экран был настроен для работы Samba.

![Настройка firewalld](06.png){ #fig:006 width=80% }

11. Для каталога /srv/sambashare были настроены корректные права доступа.

12. Просмотрены текущие SELinux-контексты каталога /srv.

13. Для каталога был назначен SELinux-контекст samba_share_t.

14. Контекст безопасности был проверен повторно.

15. Разрешён экспорт Samba-ресурсов для чтения и записи при помощи SELinux.

16. Пользователь проверил свои UID и группы.

17. На общем ресурсе пользователь создал тестовый файл.

![Создание файла в общем каталоге](07.png){ #fig:007 width=80% }

18. Пользователь был добавлен в базу учётных записей Samba.

![Добавление SMB-пользователя](08.png){ #fig:008 width=80% }

## Монтирование файловой системы Samba на клиенте

1. На клиенте были установлены необходимые пакеты samba-client и cifs-utils.

2. Был просмотрен файл конфигурации межсетевого экрана для Samba-клиента.

![Просмотр samba-client.xml](09.png){ #fig:009 width=80% }

3. На клиенте был настроен межсетевой экран для работы Samba-клиента.

4. Создана группа sambagroup и в неё добавлен пользователь.

![Создание группы и добавление пользователя](10.png){ #fig:010 width=80% }

5. В файле /etc/samba/smb.conf был изменён параметр рабочей группы.

6. Выполнена проверка наличия общих ресурсов на сервере через smbclient под анонимным пользователем.

7. Выполнено подключение через smbclient под учётной записью пользователя.

![Проверка smbclient под пользователем](11.png){ #fig:012 width=80% }

8. На клиенте создан каталог /mnt/samba для монтирования ресурса.

9. Общий ресурс был успешно подключён при помощи mount с указанием логина пользователя.

![Монтирование ресурса](12.png){ #fig:013 width=80% }

10. Пользователь проверил возможность создания файлов на смонтированном ресурсе.

![Создание файлов на ресурсе](13.png){ #fig:014 width=80% }

11. Смонтированный каталог был успешно отмонтирован.

12. На клиенте был создан файл с учётными данными /etc/samba/smbusers.

![Файл smbusers](14.png){ #fig:015 width=80% }

13. В файл /etc/fstab была добавлена строка для автоматического монтирования Samba-ресурса.

![Настройка fstab](15.png){ #fig:016 width=80% }

14. Общий ресурс был примонтирован командой mount -a, после чего проверено его присутствие в системе.

15. Пользователь подтвердил наличие доступа к файлам на смонтированном ресурсе.

![Проверка доступа к файлам](16.png){ #fig:017 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальных машин

1. На виртуальной машине server был выполнен переход в каталог /vagrant/provision/server, после чего был создан каталог smb и размещены необходимые конфигурационные файлы.

![Создание структуры каталогов и копирование конфигурации](17.png){ #fig:018 width=80% }

2. В каталоге /vagrant/provision/server был создан исполняемый файл smb.sh и назначены необходимые права доступа.

![Создание и настройка файла smb.sh](18.png){ #fig:019 width=80% }

# Вывод

В ходе лабораторной работы была выполнена полноценная настройка сервера и клиента Samba, включающая подготовку пользователей и групп, конфигурирование общего ресурса, настройку межсетевого экрана и параметров SELinux. На стороне сервера был создан и настроен сетевой каталог, организованы права доступа и обеспечена работа службы Samba. На клиентской машине был осуществлён доступ к общему ресурсу как вручную, так и с использованием автоматического монтирования через таблицу файловых систем. Проведённые проверки подтвердили корректность обмена данными, включая возможность создания файлов на разделяемом ресурсе и автоматическое подключение после перезагрузки. Итогом работы стало успешное развертывание функционирующей файловой службы Samba в локальной сети.

# Контрольные вопросы

1. **Какова минимальная конфигурация для smb.conf для создания общего ресурса, который предоставляет доступ к каталогу /data?**  
   Минимальная конфигурация включает глобальный раздел и определение ресурса:
```
[global]
workgroup = WORKGROUP

[data]
path = /data
read only = no
```
Этого достаточно, чтобы ресурс появился и был доступен.

2. **Как настроить общий ресурс, который даёт доступ на запись всем пользователям, имеющим права на запись в файловой системе Linux?**  
Нужно оставить стандартное управление правами через ФС Linux:

```
[data]
path = /data
read only = no
force user = nobody 
```
Samba не будет ограничивать доступ — запись возможна для всех пользователей, имеющих права в самой ФС.

3. **Как ограничить доступ на запись к ресурсу только членам определённой группы?**  
В конфигурации задаётся список записи:

```
write list = @groupname
```
При этом каталог должен принадлежать группе и иметь корректные права (например, `chmod 770 /data`).

4. **Какой переключатель SELinux нужно использовать, чтобы позволить пользователям получать доступ к домашним каталогам на сервере через SMB?**  
Необходимо включить boolean:

```
setsebool -P samba_enable_home_dirs on
```

5. **Как ограничить доступ к определённому ресурсу только узлам из сети 192.168.10.0/24?**  
В секции ресурса прописывается параметр:

```
hosts allow = 192.168.10.0/24
```

6. **Какую команду можно использовать, чтобы отобразить список всех пользователей Samba на сервере?**  
Используется команда:

```
pdbedit -L
```

7. **Что нужно сделать пользователю для доступа к ресурсу, который настроен как многопользовательский ресурс?**  
Пользователь должен:
- существовать в системе Linux;
- быть добавлен в Samba-базу командой `smbpasswd -a user`;
- иметь корректные права на каталог в ФС.

8. **Как установить общий ресурс Samba в качестве многопользовательской учётной записи, где пользователь alice используется как минимальная учётная запись пользователя?**  
В конфигурации ресурса указывают:

```
force user = alice
```
Все пользователи будут работать с ресурсом от имени alice.

9. **Как можно запретить пользователям просматривать учётные данные монтирования Samba в файле /etc/fstab?**  
Нужно вынести учётные данные в отдельный файл с ограниченными правами:

```
credentials=/etc/samba/smbusers
```

и установить права:

```
chmod 600 /etc/samba/smbusers
```

10. **Какая команда позволяет перечислить все экспортируемые ресурсы Samba, доступные на определённом сервере?**  
Используется команда:

```
smbclient -L //server
```
Она отображает список доступных ресурсов Samba на указанном сервере.


# Список литературы

1. Всё о Samba. — URL: http://smb-conf.ru/ (дата обр. 13.09.2021).